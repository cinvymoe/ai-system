# MessageBroker æµ‹è¯•å¥—ä»¶

æœ¬ç›®å½•åŒ…å« MessageBroker çš„å®Œæ•´æµ‹è¯•å¥—ä»¶ï¼ŒåŒ…æ‹¬å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•ã€‚

## æµ‹è¯•æ–‡ä»¶

### 1. `test_broker.py` - æ ¸å¿ƒåŠŸèƒ½å•å…ƒæµ‹è¯•

æµ‹è¯• MessageBroker çš„æ ¸å¿ƒåŠŸèƒ½ï¼š
- âœ… å•ä¾‹æ¨¡å¼
- âœ… æ¶ˆæ¯ç±»å‹æ³¨å†Œ/æ³¨é”€
- âœ… å‘å¸ƒ/è®¢é˜…æœºåˆ¶
- âœ… å¤šè®¢é˜…è€…æ”¯æŒ
- âœ… é”™è¯¯éš”ç¦»
- âœ… çº¿ç¨‹å®‰å…¨
- âœ… å†…ç½®å¤„ç†å™¨ï¼ˆDirection, Angle, AI Alertï¼‰
- âœ… ç»Ÿè®¡ä¿¡æ¯

**è¿è¡Œæ–¹å¼ï¼š**
```bash
cd backend
python -m pytest src/broker/test/test_broker.py -v
```

### 2. `test_sensor_integration.py` - ä¼ æ„Ÿå™¨é›†æˆæµ‹è¯•

æµ‹è¯•å®é™…ä¼ æ„Ÿå™¨ä¸ MessageBroker çš„é›†æˆï¼š
- âœ… JY901 ä¼ æ„Ÿå™¨æ•°æ®é‡‡é›†
- âœ… è¿åŠ¨å¤„ç†å™¨åˆ†æ
- âœ… MessageBroker æ¶ˆæ¯å‘å¸ƒ
- âœ… è®¢é˜…è€…æ¥æ”¶éªŒè¯
- âœ… æ€§èƒ½ç»Ÿè®¡

**è¿è¡Œæ–¹å¼ï¼š**
```bash
cd backend
python src/broker/test/test_sensor_integration.py
```

æˆ–ä½¿ç”¨å¿«é€Ÿæµ‹è¯•è„šæœ¬ï¼š
```bash
cd backend
python test_broker_sensor.py
```

## æµ‹è¯•è¦æ±‚

### ä¾èµ–åŒ…
```bash
pip install pytest pytest-asyncio
```

### æ•°æ®æ–‡ä»¶
ä¼ æ„Ÿå™¨é›†æˆæµ‹è¯•éœ€è¦ JY901 æ•°æ®æ–‡ä»¶ï¼š
- é»˜è®¤è·¯å¾„: `backend/data/jy901_data.txt`
- å¯ä»¥åœ¨æµ‹è¯•ä¸­æŒ‡å®šè‡ªå®šä¹‰è·¯å¾„

## æµ‹è¯•è¦†ç›–

### å•å…ƒæµ‹è¯•è¦†ç›–
- [x] å•ä¾‹æ¨¡å¼ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰
- [x] æ¶ˆæ¯ç±»å‹æ³¨å†Œï¼ˆåŒ…æ‹¬è¦†ç›–å’ŒéªŒè¯ï¼‰
- [x] å‘å¸ƒè®¢é˜…æœºåˆ¶
- [x] å¤šè®¢é˜…è€…æ”¯æŒ
- [x] è®¢é˜…è€…é”™è¯¯éš”ç¦»
- [x] æ¶ˆæ¯éªŒè¯
- [x] ç»Ÿè®¡ä¿¡æ¯è·Ÿè¸ª
- [x] èµ„æºæ¸…ç†

### é›†æˆæµ‹è¯•è¦†ç›–
- [x] ä¼ æ„Ÿå™¨æ•°æ®é‡‡é›†
- [x] è¿åŠ¨å¤„ç†å™¨é›†æˆ
- [x] æ¶ˆæ¯å‘å¸ƒæµç¨‹
- [x] è®¢é˜…è€…é€šçŸ¥
- [x] ç«¯åˆ°ç«¯æ•°æ®æµ
- [x] æ€§èƒ½æŒ‡æ ‡

## æµ‹è¯•ç¤ºä¾‹

### è¿è¡Œæ‰€æœ‰å•å…ƒæµ‹è¯•
```bash
cd backend
python -m pytest src/broker/test/test_broker.py -v -s
```

### è¿è¡Œç‰¹å®šæµ‹è¯•ç±»
```bash
cd backend
python -m pytest src/broker/test/test_broker.py::TestPublishSubscribe -v
```

### è¿è¡Œé›†æˆæµ‹è¯•ï¼ˆ30ä¸ªæ ·æœ¬ï¼‰
```bash
cd backend
python test_broker_sensor.py
```

### è¿è¡Œé›†æˆæµ‹è¯•ï¼ˆè‡ªå®šä¹‰æ ·æœ¬æ•°ï¼‰
```python
# ä¿®æ”¹ test_sensor_integration.py ä¸­çš„ max_samples å‚æ•°
await test.run_test(max_samples=100)
```

## æµ‹è¯•è¾“å‡ºç¤ºä¾‹

### å•å…ƒæµ‹è¯•è¾“å‡º
```
test_broker.py::TestBrokerSingleton::test_singleton_same_instance PASSED
test_broker.py::TestMessageTypeRegistration::test_register_message_type PASSED
test_broker.py::TestPublishSubscribe::test_publish_message PASSED
...
======================== 25 passed in 2.34s ========================
```

### é›†æˆæµ‹è¯•è¾“å‡º
```
============================================================
ä¼ æ„Ÿå™¨ä¸ MessageBroker é›†æˆæµ‹è¯•
============================================================

[1/4] åˆå§‹åŒ– JY901 ä¼ æ„Ÿå™¨...
âœ“ ä¼ æ„Ÿå™¨å·²è¿æ¥: jy901_test
  æ•°æ®æ–‡ä»¶: backend/data/jy901_data.txt
  æ•°æ®æ¡æ•°: 1000

[2/4] åˆå§‹åŒ–è¿åŠ¨å¤„ç†å™¨...
âœ“ è¿åŠ¨å¤„ç†å™¨å·²åˆå§‹åŒ–

[3/4] åˆå§‹åŒ– MessageBroker...
âœ“ MessageBroker å·²åˆå§‹åŒ–
  å·²æ³¨å†Œæ¶ˆæ¯ç±»å‹: ['direction_result', 'angle_value']

[4/4] è®¢é˜…æ¶ˆæ¯...
âœ“ å·²è®¢é˜…æ¶ˆæ¯ç±»å‹

å¼€å§‹é‡‡é›†ä¼ æ„Ÿå™¨æ•°æ®ï¼ˆæœ€å¤š 30 æ¡ï¼‰...

[æ ·æœ¬ 10] ä¼ æ„Ÿå™¨æ•°æ®:
  åŠ é€Ÿåº¦: X=0.123g, Y=-0.045g, Z=0.987g
  è§’é€Ÿåº¦: X=1.23Â°/s, Y=-0.45Â°/s, Z=2.34Â°/s
  è§’åº¦:   X=1.23Â°, Y=-0.45Â°, Z=45.67Â°
  â†’ æ–¹å‘æ¶ˆæ¯: forward (æ€»è®¡: 5)
  â†’ è§’åº¦æ¶ˆæ¯: 45.67Â° (æ€»è®¡: 10)

...

============================================================
æµ‹è¯•å®Œæˆ
============================================================

â±ï¸  æµ‹è¯•æ—¶é•¿: 1.52 ç§’

ğŸ“Š ç»Ÿè®¡ä¿¡æ¯:
  ä¼ æ„Ÿå™¨æ•°æ®é‡‡æ ·: 30 æ¡
  æ–¹å‘æ¶ˆæ¯å‘å¸ƒ:   15 æ¡
  è§’åº¦æ¶ˆæ¯å‘å¸ƒ:   30 æ¡
  é”™è¯¯æ¬¡æ•°:       0 æ¬¡

ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡:
  é‡‡æ ·é€Ÿç‡: 19.74 æ ·æœ¬/ç§’
  æ¶ˆæ¯é€Ÿç‡: 29.61 æ¶ˆæ¯/ç§’

ğŸ“¡ MessageBroker ç»Ÿè®¡:
  å·²å‘å¸ƒæ¶ˆæ¯: 45
  å¤±è´¥æ¶ˆæ¯:   0
  è®¢é˜…è€…æ€»æ•°: 2

ğŸ§­ æ–¹å‘æ¶ˆæ¯åˆ†æ:
  forward        :   8 æ¬¡ ( 53.3%)
  stationary     :   5 æ¬¡ ( 33.3%)
  turn_left      :   2 æ¬¡ ( 13.3%)

ğŸ“ è§’åº¦æ¶ˆæ¯åˆ†æ:
  æœ€å°è§’åº¦: -12.34Â°
  æœ€å¤§è§’åº¦: 89.56Â°
  å¹³å‡è§’åº¦: 45.23Â°
```

## æ•…éšœæ’é™¤

### é—®é¢˜ï¼šæ‰¾ä¸åˆ°æ•°æ®æ–‡ä»¶
```
âœ— é”™è¯¯: æ‰¾ä¸åˆ°æ•°æ®æ–‡ä»¶
```
**è§£å†³æ–¹æ¡ˆï¼š** ç¡®ä¿ `backend/data/jy901_data.txt` å­˜åœ¨ï¼Œæˆ–åœ¨æµ‹è¯•ä¸­æŒ‡å®šæ­£ç¡®çš„è·¯å¾„ã€‚

### é—®é¢˜ï¼šå¯¼å…¥é”™è¯¯
```
ModuleNotFoundError: No module named 'src'
```
**è§£å†³æ–¹æ¡ˆï¼š** ç¡®ä¿ä» `backend` ç›®å½•è¿è¡Œæµ‹è¯•ã€‚

### é—®é¢˜ï¼špytest æœªå®‰è£…
```
bash: pytest: command not found
```
**è§£å†³æ–¹æ¡ˆï¼š** å®‰è£… pytestï¼š
```bash
pip install pytest pytest-asyncio
```

## æ‰©å±•æµ‹è¯•

### æ·»åŠ è‡ªå®šä¹‰æµ‹è¯•
1. åœ¨ `test_broker.py` ä¸­æ·»åŠ æ–°çš„æµ‹è¯•ç±»
2. ä½¿ç”¨ `@pytest.fixture` åˆ›å»ºæµ‹è¯•å¤¹å…·
3. éµå¾ªç°æœ‰çš„æµ‹è¯•æ¨¡å¼

### æµ‹è¯•å®æ—¶ä¼ æ„Ÿå™¨
ä¿®æ”¹ `test_sensor_integration.py` ä¸­çš„ä¼ æ„Ÿå™¨é…ç½®ï¼š
```python
self.sensor = JY901Sensor(
    sensor_id="jy901_realtime",
    config={
        'mode': 'realtime',  # ä½¿ç”¨å®æ—¶æ¨¡å¼
        'port': '/dev/ttyUSB0',  # ä¸²å£
        'baudrate': 9600
    }
)
```

## æŒç»­é›†æˆ

è¿™äº›æµ‹è¯•å¯ä»¥é›†æˆåˆ° CI/CD æµç¨‹ä¸­ï¼š
```yaml
# .github/workflows/test.yml
- name: Run MessageBroker tests
  run: |
    cd backend
    python -m pytest src/broker/test/test_broker.py -v
```

## è´¡çŒ®

æ·»åŠ æ–°æµ‹è¯•æ—¶ï¼Œè¯·ç¡®ä¿ï¼š
1. æµ‹è¯•åç§°æ¸…æ™°æè¿°æµ‹è¯•å†…å®¹
2. åŒ…å«å¿…è¦çš„æ–‡æ¡£å­—ç¬¦ä¸²
3. æ¸…ç†æµ‹è¯•èµ„æºï¼ˆä½¿ç”¨ fixture æˆ– finallyï¼‰
4. æµ‹è¯•åº”è¯¥æ˜¯ç‹¬ç«‹çš„ï¼Œä¸ä¾èµ–å…¶ä»–æµ‹è¯•çš„çŠ¶æ€
